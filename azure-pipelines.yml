trigger: 
- main

pool: 
  vmImage: ubuntu-latest


variables:
  buildConfiguration: 'Release'
  wwwrootDir: 'Tailspin.SpaceGame.Web/wwwroot'
  dotnetSdkVersion: '6.x'

stages:
    - stage: Build
      displayName: Build App
      jobs:
        - job: Build
          steps:
            - task: UseDotNet@2
              displayName: 'Use .NET SDK $(dotnetSdkVersion)'
              inputs:
                  packageType: sdk
                  version: '$(dotnetSdkVersion)'
            - task: Npm@1
              displayName: 'Run npm install'
              inputs:
                verbose: false
            
            - task: CmdLine@2
              displayName: 'Compile Sass assets'
              inputs:
                script: './node_modules/.bin/node-sass $(wwwrootDir) --output $(wwwrootDir)'
            
            - task: gulp@1
              displayName: 'Run gulp tasks'
            
            #Shortcut for CmdLine@2
            - script: 'echo "$(Build.DefinitionName), $(Build.BuildId), $(Build.BuildNumber)" > buildinfo.txt'
              displayName: 'Write build info'
              workingDirectory: $(wwwrootDir)
            
            - task: DotNetCoreCLI@2
              displayName: 'Restore project dependencies'
              inputs:
                command: 'restore'
                projects: '**/*.csproj'
            
            - task: DotNetCoreCLI@2
              displayName: 'Build Project - $(buildConfiguration)'
              inputs:
                command: 'build'
                projects: '**/*.csproj'
                arguments: '--no-restore --configuration $(buildConfiguration)'     
            - task: DotNetCoreCLI@2
              displayName: 'Publish Project - $(buildConfiguration)'
              inputs:
                command: 'publish'
                projects: '**/*.csproj'
                publishWebProjects: false
                arguments: '--no-build --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/$(buildConfiguration)'
                zipAfterPublish: true
            
            - task: PublishBuildArtifacts@1
              condition: succeeded()
              inputs:
                PathtoPublish: '$(Build.ArtifactStagingDirectory)'
                ArtifactName: 'drop'              
 
    - stage: Test
      displayName: Test stage
      jobs:
        - job: TestJob
          steps:
            - bash: echo "Test Job - Bash Step"      